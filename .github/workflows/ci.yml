name: CI
on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install and test collector
        working-directory: src/collector
        run: |
          npm ci
          npm test
      - name: Lint (light)
        run: echo "No linter configured; add ESLint in future"

  smoke-test:
    name: Smoke Test (Docker Compose)
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v3
      - name: Prepare runner
        run: |
          sudo apt-get update && sudo apt-get install -y jq
      - name: Build and start services
        run: |
          docker compose up --build -d
      - name: Wait for services to become healthy
        run: |
          for i in {1..30}; do
            if curl -sSf http://localhost:8083/health && curl -sSf http://localhost:8084/health; then echo "services up"; exit 0; fi
            echo "waiting... ($i)"; sleep 2
          done
          echo "services failed to start"; exit 1
      - name: Generate sample traffic
        run: bash scripts/generate_sample_traffic.sh 3
      - name: Inject deterministic high-severity event (with retry & logs)
        run: |
          set -e
          PAYLOAD='{"path":"/admin","ua":"nmap/7.80"}'
          # initialize injector log
          echo "" > injector_logs.txt
          for attempt in 1 2 3; do
            echo "POST /hit attempt $attempt" | tee -a injector_logs.txt
            RESP=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST http://localhost:8083/hit -H "Content-Type: application/json" -d "$PAYLOAD" || true)
            echo "Response:" | tee -a injector_logs.txt
            echo "$RESP" | tee -a injector_logs.txt
            STATUS=$(echo "$RESP" | sed -n 's/.*HTTP_STATUS:\([0-9][0-9][0-9]\)/\1/p' || true)
            if echo "$STATUS" | grep -E '^[0-9]{3}$' >/dev/null 2>&1 && [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 300 ]; then
              echo "POST succeeded (status $STATUS)" | tee -a injector_logs.txt
              break
            fi
            echo "POST failed or non-2xx status ($STATUS); retrying..." | tee -a injector_logs.txt
            sleep 2
          done
          echo "Waiting 3s for collector to process event..." | tee -a injector_logs.txt
          sleep 3
      - name: Verify reports contain expected entries
        run: |
          set -e
          found=1
          for i in {1..20}; do
            RESPONSE=$(curl -s http://localhost:8084/reports || true)
            echo "Attempt $i: /reports response:"
            echo "$RESPONSE" | jq -r '.[] | "id: \(.id) severity: \(.severity) path: \(.path) ua: \(.ua)"' | tee reports.txt
            if grep -q HIGH reports.txt; then
              echo "Found HIGH in reports"
              found=0
              break
            fi
            echo "HIGH not found yet; retry ($i/20)"
            sleep 2
          done
          if [ "$found" -ne 0 ]; then
            echo "Final reports (last attempt):"
            cat reports.txt || true
            exit 1
          fi
      - name: Print smoke-test diagnostics (reports + injector logs)
        if: always()
        run: |
          echo "==== reports.txt ===="
          if [ -f reports.txt ]; then
            cat reports.txt || true
          else
            echo "(reports.txt missing)"
          fi
          echo "==== injector_logs.txt ===="
          if [ -f injector_logs.txt ]; then
            cat injector_logs.txt || true
          else
            echo "(injector_logs.txt missing)"
          fi
      - name: Upload smoke-test diagnostics (reports + injector logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-diagnostics
          path: |
            reports.txt
            injector_logs.txt
      - name: Tear down
        if: always()
        run: docker compose down -v

