name: CI
on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install and test collector
        working-directory: src/collector
        run: |
          npm ci
          npm test
      - name: Lint (light)
        run: echo "No linter configured; add ESLint in future"

  smoke-test:
    name: Smoke Test (Docker Compose)
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v3
      - name: Prepare runner
        run: |
          sudo apt-get update && sudo apt-get install -y jq
      - name: Build and start services
        run: |
          docker compose up --build -d
      - name: Wait for services to become healthy
        run: |
          for i in {1..30}; do
            if curl -sSf http://localhost:8083/health && curl -sSf http://localhost:8084/health; then echo "services up"; exit 0; fi
            echo "waiting... ($i)"; sleep 2
          done
          echo "services failed to start"; exit 1
      - name: Show service status & recent logs
        run: |
          docker compose ps
          docker compose logs --tail=200 --no-color
      - name: Generate sample traffic
        run: bash scripts/generate_sample_traffic.sh 3
      - name: Inject deterministic high-severity event (with retry & logs)
        run: |
          set -e
          PAYLOAD='{"path":"/admin","ua":"nmap/7.80"}'
          # initialize injector log
          echo "" > injector_logs.txt
          echo "curl binary: $(which curl || echo '(curl not found)')" | tee -a injector_logs.txt
          for attempt in 1 2 3; do
            echo "POST /hit attempt $attempt" | tee -a injector_logs.txt
            echo "Health check (before POST):" | tee -a injector_logs.txt
            curl -sS -I http://localhost:8083/health 2>&1 | sed -n '1,8p' | tee -a injector_logs.txt || true
            # POST with retries via curl; capture stderr to file for diagnostics
            RESP=$(curl --fail --retry 3 --retry-delay 2 -s -w "\nHTTP_STATUS:%{http_code}" -v -X POST http://localhost:8083/hit -H "Content-Type: application/json" -d "$PAYLOAD" 2>curl_err.txt || true)
            echo "Response:" | tee -a injector_logs.txt
            echo "$RESP" | tee -a injector_logs.txt
            echo "Curl stderr:" | tee -a injector_logs.txt
            cat curl_err.txt | tee -a injector_logs.txt || true
            STATUS=$(echo "$RESP" | sed -n 's/.*HTTP_STATUS:\([0-9][0-9][0-9]\)/\1/p' || true)
            if echo "$STATUS" | grep -E '^[0-9]{3}$' >/dev/null 2>&1 && [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 300 ]; then
              echo "POST succeeded (status $STATUS)" | tee -a injector_logs.txt
              break
            fi
            echo "POST failed or non-2xx status ($STATUS); retrying..." | tee -a injector_logs.txt
            sleep 2
          done
          echo "Waiting 3s for collector to process event..." | tee -a injector_logs.txt
          sleep 3
      - name: Verify reports contain expected entries
        run: |
          set -e
          found=1
          for i in {1..20}; do
            echo "Attempt $i: /reports (raw headers + body):"
            curl -sS -D - http://localhost:8084/reports -o reports_body.txt 2>&1 | sed -n '1,40p' | tee reports_raw_$i.txt || true
            echo "=== parsed body ==="
            cat reports_body.txt | jq -r '.[] | "id: \(.id) severity: \(.severity) path: \(.path) ua: \(.ua)"' | tee reports.txt || true
            RESPONSE=$(cat reports_body.txt || true)
            # Check specifically for the injected event (path "/admin", ua contains "nmap", severity "HIGH")
            if echo "$RESPONSE" | jq -e '.[] | select(.path=="/admin" and (.ua|test("nmap"; "i")) and .severity=="HIGH")' >/dev/null 2>&1; then
              echo "Found expected injected HIGH event (path=/admin, ua~nmap)"
              found=0
              break
            fi
            echo "Expected injected event not found yet; retry ($i/20)"
            sleep 2
          done
          if [ "$found" -ne 0 ]; then
            echo "Final reports (last attempt):"
            cat reports.txt || true
            ls -la reports_raw_*.txt || true
            exit 1
          fi
      - name: Print smoke-test diagnostics (reports + injector logs)
        if: always()
        run: |
          echo "==== reports.txt ===="
          if [ -f reports.txt ]; then
            cat reports.txt || true
          else
            echo "(reports.txt missing)"
          fi
          echo "==== injector_logs.txt ===="
          if [ -f injector_logs.txt ]; then
            cat injector_logs.txt || true
          else
            echo "(injector_logs.txt missing)"
          fi
      - name: Upload smoke-test diagnostics (reports + injector logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-diagnostics
          path: |
            reports.txt
            injector_logs.txt
            reports_raw_*.txt
      - name: Tear down
        if: always()
        run: docker compose down -v

