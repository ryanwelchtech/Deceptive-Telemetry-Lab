name: CI
on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install and test collector
        working-directory: src/collector
        run: |
          npm ci
          npm test
      - name: Lint (light)
        run: echo "No linter configured; add ESLint in future"

  smoke-test:
    name: Smoke Test (Docker Compose)
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v3
      - name: Prepare runner
        run: |
          sudo apt-get update && sudo apt-get install -y jq
      - name: Build and start services
        run: |
          docker compose up --build -d
      - name: Wait for services to become healthy
        run: |
          for i in {1..30}; do
            if curl -sSf http://localhost:8083/health && curl -sSf http://localhost:8084/health; then echo "services up"; exit 0; fi
            echo "waiting... ($i)"; sleep 2
          done
          echo "services failed to start"; exit 1
      - name: Generate sample traffic
        run: bash scripts/generate_sample_traffic.sh 3
      - name: Inject deterministic high-severity event
        run: |
          curl -s -X POST http://localhost:8083/hit -H "Content-Type: application/json" -d '{"path":"/admin","ua":"nmap/7.80"}' || true
          sleep 1
      - name: Verify reports contain expected entries
        run: |
          set -e
          found=1
          for i in {1..10}; do
            RESPONSE=$(curl -s http://localhost:8084/reports || true)
            echo "$RESPONSE" | jq -r '.[] | "id: \(.id) severity: \(.severity)"' | tee reports.txt
            if grep -q HIGH reports.txt; then
              echo "Found HIGH in reports"
              found=0
              break
            fi
            echo "HIGH not found yet; retry ($i/10)"
            sleep 1
          done
          if [ "$found" -ne 0 ]; then
            echo "Final reports:"
            cat reports.txt || true
            exit 1
          fi
      - name: Tear down
        if: always()
        run: docker compose down -v

